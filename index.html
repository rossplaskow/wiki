<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Wikipedia Articles for Creative Technologists</title>
  <!-- Use viewport-fit=cover for safe area adjustments -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <style>
    /* Reset */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    /* Full-screen layout */
    body {
      background-color: #000;
      font-family: Arial, sans-serif;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }
    /* API Key Overlay – centered */
    #apikey-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      padding-bottom: env(safe-area-inset-bottom);
      background: rgba(0, 0, 0, 1);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 100;
    }
    #apikey-overlay h2 {
      margin-bottom: 20px;
    }
    #apikey-overlay input {
      padding: 10px;
      width: 80%;
      max-width: 300px;
      font-size: 1em;
      border-radius: 5px;
      border: none;
      margin-bottom: 20px;
      autocapitalize: none;
      autocomplete: off;
      spellcheck: false;
      inputmode: text;
    }
    #apikey-overlay button {
      padding: 10px 20px;
      font-size: 1em;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      background: rgb(244, 255, 95);
    }
    /* Simulated Phone Screen */
    #phone-container {
      position: relative;
      width: 375px;
      height: calc(100vh - env(safe-area-inset-bottom) - 20px);
      background: #000;
      border: 0;
      border-radius: 40px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(255,255,255,0.1);
      touch-action: none;
    }
    /* Pages Container – centered */
    #pages {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      transition: transform 0.3s ease;
      will-change: transform;
    }
    /* Each full-screen page */
    .page {
      width: 100%;
      height: 100%;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
    }
    /* Inner wrapper to adjust vertical position (shift down by 10%) */
    .page-content {
      transform: translateY(10%);
    }
    /* Title and extract styling */
    .title {
      font-size: 2em;
      font-weight: bold;
      margin-bottom: 15px;
    }
    .extract {
      font-size: 1.2em;
      line-height: 1.5;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      -webkit-line-clamp: 16;
    }
  </style>
</head>
<body>
  <!-- API Key Overlay -->
  <div id="apikey-overlay">
    <h2>Enter Your OpenAI API Key</h2>
    <input type="text" id="apikey-input" placeholder="sk-..." autocapitalize="none" autocomplete="off" spellcheck="false" inputmode="text">
    <button id="apikey-ok">OK</button>
  </div>

  <!-- Phone Container -->
  <div id="phone-container">
    <div id="pages">
      <!-- Pages will be appended here -->
    </div>
  </div>

  <script>
    /***** API KEY SETUP *****/
    let openAiApiKey = localStorage.getItem('openAiApiKey') || "";
    const apikeyOverlay = document.getElementById('apikey-overlay');
    const apikeyInput = document.getElementById('apikey-input');
    const apikeyOk = document.getElementById('apikey-ok');
    if (openAiApiKey) {
      apikeyOverlay.style.display = 'none';
    }
    apikeyOk.addEventListener('click', () => {
      openAiApiKey = apikeyInput.value.trim();
      if (openAiApiKey) {
        localStorage.setItem('openAiApiKey', openAiApiKey);
        apikeyOverlay.style.display = 'none';
        preloadGPTPages(2);
      }
    });
    
    /***** LAYOUT & VARIABLES *****/
    const phoneContainer = document.getElementById('phone-container');
    const pagesContainer = document.getElementById('pages');
    const phoneHeight = phoneContainer.clientHeight;
    let activeIndex = 0;
    let startY = 0;
    let isDragging = false;
    
    /***** GPT & PAGE CHAIN FUNCTIONS *****/
    // getGPTKeyword: Always calls GPT with a fixed prompt and returns a keyword.
    async function getGPTKeyword() {
      if (!openAiApiKey) return null;
      const prompt = 
`You are a creative and analytical research assistant.
Return a single, concise search term that a creative technologist would be interested in.
Randomness up to the max so we get good variety.
Return only the search term.`;
      try {
        const response = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + openAiApiKey
          },
          body: JSON.stringify({
            model: "chatgpt-4o-latest",
            messages: [
              { role: "system", content: "You are a highly analytical research assistant." },
              { role: "user", content: prompt }
            ],
            max_tokens: 10,
            temperature: 0.7
          })
        });
        if (!response.ok) throw new Error("OpenAI API request failed");
        const data = await response.json();
        const term = data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content.trim();
        console.log("GPT returned search term:", term);
        return term;
      } catch (error) {
        console.error("Error fetching GPT keyword:", error);
        return null;
      }
    }
    
    // fetchArticleByQuery and fetchRandomArticle as before:
    async function fetchRandomArticle() {
      try {
        const response = await fetch('https://en.wikipedia.org/api/rest_v1/page/random/summary');
        if (!response.ok) throw new Error('Network response was not ok');
        return await response.json();
      } catch (error) {
        console.error('Error fetching article:', error);
        return { title: 'Error', extract: 'Could not load article.' };
      }
    }
    
    async function fetchArticleByQuery(query) {
      try {
        const searchUrl = `https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(query)}&srlimit=50&format=json&origin=*`;
        const response = await fetch(searchUrl);
        if (!response.ok) throw new Error("Search request failed");
        const data = await response.json();
        const results = data.query.search;
        if (results && results.length > 0) {
          const randomResult = results[Math.floor(Math.random() * results.length)];
          const summaryUrl = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(randomResult.title)}`;
          const summaryResponse = await fetch(summaryUrl);
          if (!summaryResponse.ok) throw new Error("Summary request failed");
          return await summaryResponse.json();
        } else {
          return await fetchRandomArticle();
        }
      } catch (error) {
        console.error("Error fetching article by query:", error);
        return await fetchRandomArticle();
      }
    }
    
    // createPage: Always use the provided GPT keyword (query) to fetch an article.
    async function createPage(query) {
      let article = await fetchArticleByQuery(query);
      const page = document.createElement('div');
      page.className = 'page';
      
      if (article.content_urls && article.content_urls.desktop && article.content_urls.desktop.page) {
        page.dataset.pageUrl = article.content_urls.desktop.page;
      }
      
      // Wrap content in .page-content for vertical adjustment.
      const contentWrapper = document.createElement('div');
      contentWrapper.className = 'page-content';
      
      const titleEl = document.createElement('div');
      titleEl.className = 'title';
      titleEl.textContent = article.title || 'No Title';
      
      const extractEl = document.createElement('div');
      extractEl.className = 'extract';
      extractEl.textContent = article.extract || 'No extract available.';
      
      contentWrapper.appendChild(titleEl);
      contentWrapper.appendChild(extractEl);
      page.appendChild(contentWrapper);
      
      // Double-click (desktop) opens the article.
      page.addEventListener('dblclick', () => {
        if (page.dataset.pageUrl) window.open(page.dataset.pageUrl, '_blank');
      });
      
      // Double-tap (mobile) detection.
      let lastTap = 0;
      page.addEventListener('touchend', (e) => {
        const currentTime = new Date().getTime();
        const tapLength = currentTime - lastTap;
        if (tapLength < 300 && tapLength > 0) {
          if (page.dataset.pageUrl) window.open(page.dataset.pageUrl, '_blank');
          e.preventDefault();
        }
        lastTap = currentTime;
      });
      
      return page;
    }
    
    async function appendPageUsingGPT() {
      let keyword = await getGPTKeyword();
      if (!keyword) {
        // If GPT fails, pick a random fallback keyword.
        const fallbacks = ["technology", "AI", "economics", "quantum computing", "science", "bitcoin", "aviation"];
        keyword = fallbacks[Math.floor(Math.random() * fallbacks.length)];
      }
      const page = await createPage(keyword);
      pagesContainer.appendChild(page);
    }

    
    // Preload N pages using GPT.
    async function preloadGPTPages(count) {
      for (let i = 0; i < count; i++) {
        await appendPageUsingGPT();
      }
    }
    
    // --- Transform Update ---
    function setTranslateY(translateY, withTransition = false) {
      pagesContainer.style.transition = withTransition ? 'transform 0.3s ease' : 'none';
      pagesContainer.style.transform = `translateY(${translateY}px)`;
    }
    
    // --- Swipe Handling (Forward Only) ---
    // Only allow upward swipes (no backward scrolling).
    phoneContainer.addEventListener('touchstart', (e) => {
      if (e.touches.length !== 1) return;
      isDragging = true;
      startY = e.touches[0].clientY;
      setTranslateY(-activeIndex * phoneHeight, false);
    });
    
    phoneContainer.addEventListener('touchmove', (e) => {
      if (!isDragging) return;
      const currentY = e.touches[0].clientY;
      const deltaY = currentY - startY;
      setTranslateY(-activeIndex * phoneHeight + deltaY, false);
    });
    
    phoneContainer.addEventListener('touchend', (e) => {
      if (!isDragging) return;
      isDragging = false;
      const endY = e.changedTouches[0].clientY;
      const deltaY = endY - startY;
      if (Math.abs(deltaY) < 5) {
        setTranslateY(-activeIndex * phoneHeight, true);
        return;
      }
      const threshold = phoneHeight * 0.15;
      // Only allow upward swipe (deltaY negative) to go forward.
      if (deltaY < -threshold && activeIndex < pagesContainer.children.length - 1) {
        activeIndex++;
      }
      setTranslateY(-activeIndex * phoneHeight, true);
      // Always preload the next page using GPT.
      if (activeIndex >= pagesContainer.children.length - 1) {
        appendPageUsingGPT();
      }
    });
    
    // Mouse events for desktop – only allow forward scrolling.
    let mouseDown = false;
    let mouseStartY = 0;
    phoneContainer.addEventListener('mousedown', (e) => {
      mouseDown = true;
      mouseStartY = e.clientY;
      setTranslateY(-activeIndex * phoneHeight, false);
    });
    
    phoneContainer.addEventListener('mousemove', (e) => {
      if (!mouseDown) return;
      const deltaY = e.clientY - mouseStartY;
      setTranslateY(-activeIndex * phoneHeight + deltaY, false);
    });
    
    phoneContainer.addEventListener('mouseup', (e) => {
      if (!mouseDown) return;
      mouseDown = false;
      const deltaY = e.clientY - mouseStartY;
      if (Math.abs(deltaY) < 5) {
        setTranslateY(-activeIndex * phoneHeight, true);
        return;
      }
      const threshold = phoneHeight * 0.15;
      if (deltaY < -threshold && activeIndex < pagesContainer.children.length - 1) {
        activeIndex++;
      }
      setTranslateY(-activeIndex * phoneHeight, true);
      if (activeIndex >= pagesContainer.children.length - 1) {
        appendPageUsingGPT();
      }
    });
    
    phoneContainer.addEventListener('mouseleave', () => {
      if (mouseDown) {
        mouseDown = false;
        setTranslateY(-activeIndex * phoneHeight, true);
      }
    });
    
    // --- Preload New Page on Scroll ---
    // When the transition ends (i.e. a page is fully in view), immediately preload a new page.
    pagesContainer.addEventListener('transitionend', (e) => {
      if (e.propertyName !== "transform") return;
      if (activeIndex >= pagesContainer.children.length - 1) {
        appendPageUsingGPT();
      }
    });
    
    // Initial load: Call GPT twice to create the first two pages.
    preloadGPTPages(2);
  </script>
</body>
</html>
